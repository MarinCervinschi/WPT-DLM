services:
  mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: wpt-dlm-mqtt
    ports:
      - "${MQTT_PORT:-1883}:1883"
    volumes:
      - ./config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - wpt-dlm-network
    restart: always

  influxdb:
    image: influxdb:2.7
    container_name: wpt-dlm-influxdb
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    env_file:
      - .env
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - wpt-dlm-network
    restart: always

  telegraf:
    image: telegraf:1.28
    container_name: wpt-dlm-telegraf
    depends_on:
      - mqtt-broker
      - influxdb
    env_file:
      - .env
    volumes:
      - ./config/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    networks:
      - wpt-dlm-network
    restart: always

  grafana:
    image: grafana/grafana:10.2.0
    container_name: wpt-dlm-grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    env_file:
      - .env
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - influxdb
      - postgres
    networks:
      - wpt-dlm-network
    restart: always

  postgres:
    image: postgres:16-alpine
    container_name: wpt-dlm-postgres
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - wpt-dlm-network
    restart: always

  brain_api:
    build:
      context: .
      dockerfile: ./brain_api/Dockerfile
    container_name: wpt-dlm-brain-api
    ports:
      - "${BRAIN_API_PORT:-8000}:8000"
    env_file:
      - .env
    depends_on:
      - mqtt-broker
      - influxdb
      - postgres
    networks:
      - wpt-dlm-network
    restart: always

networks:
  wpt-dlm-network:
    driver: bridge

volumes:
  mosquitto_data:
  mosquitto_log:
  influxdb_data:
  influxdb_config:
  grafana_data:
  postgres_data:
  brain_api_data:
